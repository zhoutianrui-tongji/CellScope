io:
  final_format: csv
  h5ad_compression: lzf
  resume_from: 
  intermediate_dirname: intermediate_results
  write_csv_copy: true
  lite_intermediate: true
  write_intermediate_csv: true
  write_intermediate_parquet: false
  write_intermediate_figures: true
  drop_embeddings: true
  keep_intermediate: false

module1:
  knn_k: 32
  include_directional: true
  winsor_perc_low: 1
  winsor_perc_high: 99

module2:
  top_g: 4096
  bow_knn_k: 32
  max_rows_per_cell_for_svd: 500
  max_svd_rows: 2000000
  svd_n_components: 24
  bow_weight_mode: gaussian   # gaussian | uniform
  use_tfidf: true
  tf_norm: true
  parallel_chunk_cells: 128

module3:
  hdbscan_min_cluster_size: 6
  hdbscan_allow_single_cluster: true
  hdbscan_min_samples_frac: 0.3
  target_sub_size: 12
  n_feat_hdb: 16
  kmeans_min_k: 2
  kmeans_max_k: 100
  use_k_cap: false
  merge_min_size: null    # 若为 null，则按 MIN_SUB_PTS 合并小簇（推荐）
  hdbscan_max_points: 600         # 1 表示全部使用 MiniBatchKMeans（跳过 HDBSCAN）
  kmeans_train_size: 512        # per-cell MiniBatchKMeans 的训练采样数（小样本更快）
  kmeans_batch_size: 1024       # per-cell MiniBatchKMeans 的 batch_size（减轻单批开销）
  small_backend_cells: 1000     # 低于该值时用线程后端，5k 不触发
  sequential_cells: 1000           # 禁用顺序模式，避免 5k 时退化到串行

module5:
  block_size: 50000
  # SimpleK feature weights and options
  w_gc: 0.5
  w_expr: 0.5
  w_sp: 0.0
  use_gc: true
  use_expr: true
  speed_preset: ultra
  use_spatial_feats: true
  use_decell: true
  use_cosine: true
  enable_cap: true
  # K estimation
  estimate_k: auto        # auto | fixed
  fixed_k: 1024           # used when estimate_k=fixed
  target_sub_per_cluster: 800
  target_cluster_per_cell: 1.0
  K_min: 200
  K_max: 8000
  # Nucleus/cytoplasm split
  split_by_nucleus: true
  nucleus_threshold: 0.0
  # Per-cell cap parameters
  cap_ratio_base: 0.015
  cap_min_keep: 3
  cap_margin_tau: 0.015
  cap_max_frac_soft: 0.05
  # Two-stage MiniBatchKMeans (fit on sample, predict all)
  train_sample_per_block: 600000   # 每个 block 用于训练的采样上限
  assign_chunk_size: 50000         # 预测阶段内部 chunk 尺寸（若 predict 内存充足可无视）
  mbk_batch_size: 8192
  mbk_max_iter: 80

module6:
  h5ad_compression_override: true
  save_shape_summary: true

module7:
  scvi_epochs: 200
  scvi_n_latent: 32
  scvi_lr: 0.001
  scvi_batch_size: 1024
  # Optional: priority representations for annotation stage (default prefers X_dgi_gcn)
  rep_priority: ["X_dgi_gcn", "X_dgi_sage", "X_expr", "X_pca"]
  neighbors:
    k_expr: 15
    k_geom: 15
  alpha_expr: 0.5
  alpha_geom: 0.5
  same_cell_beta: 0.5
  topk_prune: 32
  edge_norm: rw              # rw | gcn | none
  feature_scale: standard    # standard | none

module8:
  dgi_epochs: 150
  enable_dgi_sage: true
  dgi_hidden: 32
  dgi_out: 32
  dgi_lr: 0.001
  dgi_weight_decay: 0.0001
  dgi_clip_grad: 1.0

annotation:
  enable: true
  method: rapx
  two_stage: true
  spatial_channel: true
  leiden_resolution: 1.0
  hvg_n_top_genes: 2000
  pca_n_comps: 32
  neighbors_k: 32
  umap_min_dist: 0.3
  umap_spread: 1.0
  compute_umap: true
  save_umap_plot: true
  save_plots: true
  # Preferred representation for Leiden/UMAP (options: X_dgi_gcn|X_dgi_sage|X_expr|X_pca|auto)
  cluster_rep: "X_dgi_gcn"

runtime:
  n_jobs: 48
  joblib_backend: loky
  blas_threads: 2
  use_threadpoolctl: true

ui:
  show_sample: true
  progress_style: rich
